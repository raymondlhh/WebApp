<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forgot Password</title>
  <link rel="stylesheet" href="../CSS/ForgotPassword.css">
  <link rel="stylesheet" href="../CSS/Navbar.css">
  <link rel="stylesheet" href="../CSS/Footer.css">
  <!-- Firebase CDN scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Firebase initialization -->
  <script src="../JavaScript/firebase-init.js"></script>
</head>
<body>
  <div class="container">
    <img src="../assets/images/icons/welcome_screen/Logo.png" alt="Logo" class="logo">
    <img src="../assets/images/icons/welcome_screen/subtitle.png" alt="Subtitle" class="subtitle">
    
    <div class="error-message" id="error-msg"></div>
    <div class="success-message" id="success-msg"></div>
    
    <input type="email" id="forgot-email" placeholder="Email" class="input-field email-input" required>
    
    <button type="button" id="find-email-btn" class="find-email-button">Find Email</button>
    
    <div id="new-password-section" class="new-password-section">
      <input type="password" id="new-password" placeholder="New Password" class="new-password-input" required>
      <button type="button" id="reset-password-btn" class="reset-password-button">Reset Password</button>
    </div>
    
    <a href="Login.html" class="back-to-login">Back to Login</a>
  </div>
  
  <script>
    let emailFound = false;
    let userDocId = null;
    
    // Helper function to get Firebase instances
    function getFirebaseInstances() {
      if (!window.firebase) {
        throw new Error('Firebase not initialized');
      }
      return {
        auth: window.auth || firebase.auth(),
        db: window.db || firebase.firestore()
      };
    }
    
    // Helper function to show error message
    function showError(message) {
      const errorMsg = document.getElementById('error-msg');
      const successMsg = document.getElementById('success-msg');
      errorMsg.textContent = message;
      errorMsg.style.display = 'block';
      successMsg.style.display = 'none';
    }
    
    // Helper function to show success message
    function showSuccess(message) {
      const errorMsg = document.getElementById('error-msg');
      const successMsg = document.getElementById('success-msg');
      successMsg.textContent = message;
      successMsg.style.display = 'block';
      errorMsg.style.display = 'none';
    }
    
    // Helper function to set loading state
    function setLoadingState(button, isLoading, loadingText = 'Loading...', originalText = '') {
      if (isLoading) {
        button.disabled = true;
        button.textContent = loadingText;
      } else {
        button.disabled = false;
        button.textContent = originalText;
      }
    }
    
    document.getElementById('find-email-btn').addEventListener('click', async function() {
      const email = document.getElementById('forgot-email').value.trim();
      const errorMsg = document.getElementById('error-msg');
      const successMsg = document.getElementById('success-msg');
      const newPasswordSection = document.getElementById('new-password-section');
      const findEmailBtn = document.getElementById('find-email-btn');
      
      // Hide previous messages
      errorMsg.style.display = 'none';
      successMsg.style.display = 'none';
      
      // Validate email
      if (!email || !email.includes('@')) {
        showError('Please enter a valid email address');
        return;
      }
      
      // Set loading state
      setLoadingState(findEmailBtn, true, 'Checking...', 'Find Email');
      
      try {
        const { auth, db } = getFirebaseInstances();
        
        console.log('Checking email:', email);
        
        // First, try to find user in Firestore (this is where your user data is stored)
        const userQuery = await db.collection('users').where('email', '==', email).get();
        
        if (!userQuery.empty) {
          // User found in Firestore
          console.log('User found in Firestore');
          emailFound = true;
          userDocId = userQuery.docs[0].id;
          
          // Show new password section
          newPasswordSection.style.display = 'block';
          findEmailBtn.style.display = 'none';
          
          // Focus on new password field
          document.getElementById('new-password').focus();
          
          showSuccess('Email found! Please enter your new password.');
          setLoadingState(findEmailBtn, false, '', 'Find Email');
          return;
        }
        
        // If not found in Firestore, check Firebase Auth as fallback
        console.log('User not found in Firestore, checking Firebase Auth...');
        try {
          const methods = await auth.fetchSignInMethodsForEmail(email);
          
          if (methods.length > 0) {
            // User exists in Firebase Auth but not in Firestore
            console.log('User found in Firebase Auth but not in Firestore');
            showError('Account found but user data is missing. Please contact support.');
            setLoadingState(findEmailBtn, false, '', 'Find Email');
            return;
          }
        } catch (authError) {
          console.log('Firebase Auth check failed:', authError);
          // Continue with the error message below
        }
        
        // If we get here, user was not found in either place
        console.log('User not found in either Firestore or Firebase Auth');
        showError('No account found with this email address. Please check the email or create a new account.');
        setLoadingState(findEmailBtn, false, '', 'Find Email');
        
      } catch (error) {
        console.error('Error checking email:', error);
        showError('An error occurred while checking the email. Please try again.');
        setLoadingState(findEmailBtn, false, '', 'Find Email');
      }
    });
    
    document.getElementById('reset-password-btn').addEventListener('click', async function() {
      const newPassword = document.getElementById('new-password').value;
      const errorMsg = document.getElementById('error-msg');
      const successMsg = document.getElementById('success-msg');
      const resetBtn = document.getElementById('reset-password-btn');
      
      // Hide previous messages
      errorMsg.style.display = 'none';
      successMsg.style.display = 'none';
      
      // Validate new password
      if (!newPassword) {
        showError('Please enter new password');
        return;
      }
      
      if (newPassword.length < 6) {
        showError('Password must be at least 6 characters long');
        return;
      }
      
      // Set loading state
      setLoadingState(resetBtn, true, 'Resetting...', 'Reset Password');
      
      try {
        const { auth, db } = getFirebaseInstances();
        
        // Get the user document
        const userDoc = await db.collection('users').doc(userDocId).get();
        
        if (!userDoc.exists) {
          showError('User account not found');
          setLoadingState(resetBtn, false, '', 'Reset Password');
          return;
        }
        
        const userData = userDoc.data();
        
        // Update password in Firestore
        await db.collection('users').doc(userDocId).update({
          password: newPassword, // In production, this should be encrypted
          updatedAt: new Date()
        });
        
        // Send password reset email via Firebase Auth
        await auth.sendPasswordResetEmail(userData.email);
        
        showSuccess('Password reset email sent! Please check your email to complete the reset.');
        
        // Redirect to login after a delay
        setTimeout(() => {
          window.location.href = 'Login.html';
        }, 3000);
        
      } catch (error) {
        console.error('Error resetting password:', error);
        let errorMessage = 'An error occurred while resetting the password';
        
        switch (error.code) {
          case 'auth/user-not-found':
            errorMessage = 'No account found with this email address';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email address';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Too many requests. Please try again later';
            break;
          case 'auth/network-request-failed':
            errorMessage = 'Network error. Please check your connection';
            break;
          default:
            errorMessage = error.message || 'Password reset failed. Please try again.';
        }
        
        showError(errorMessage);
        setLoadingState(resetBtn, false, '', 'Reset Password');
      }
    });
  </script>
  
  <div id="footer-container"></div>
  <script>
      // Load the footer component
      fetch('Footer.html')
          .then(response => response.text())
          .then(html => {
              document.getElementById('footer-container').innerHTML = html;
          })
          .catch(error => {
              console.error('Error loading footer:', error);
          });
  </script>
</body>
</html> 